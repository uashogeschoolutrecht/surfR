---
title: "Exercise - Factors"
author: "Marc A.T. Teunis"
date: '`r Sys.Date()`'
output:
  html_document:
    css: ~/hp_r_course/exercises/exercises_style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      fig.show = 'hide',
                      results = 'hide',
                      warning = FALSE, 
                      message = FALSE, 
                      error = FALSE)
```

```{r, root_1, include=FALSE}
## defines the root of the project for later use
require("rprojroot") || utils::install.packages("rprojroot")
library(rprojroot)
root <- find_root_file(criterion = is_rstudio_project)
```

```{r, packages, echo=TRUE}
library(tidyverse)
library(forcats)
```

__Write an Rmd file, containing code chunks (if applicable) and answer all the questions below. Store the file in a folder called: "./answers_exercises" in your course project folder. Give this file the same name as the title of the current Rmd file__

## Exploring a factor variable

**TIPS**

 - use the package {forcats} to explore and change factors 
 - load the package by `library(forcats)`
 - load the dataset "General Social Survey" with: 
 
```{r, echo=TRUE, results='markup'}
gss_cat <- forcats::gss_cat
head(gss_cat)
```

1A) Explore the distribution of the `rincome` variable from `forcats::gss_cat` (reported income). What makes the
default bar chart hard to understand? How could you improve the plot?

 - Is a bar plot the right plot?
 - Do you need to summarize `rincome` and or add a new variable to the dataset?
 - Try using length()
 - How would you rotate the labels on the plot 90o? Search in Google "rotating x axis labels ggplot2" and see where its gets you.
 - To reorde a factor you can use `forcats::fct_reorder` look at the help function or in the book/slides how to use this function.
 - Google "reorder factor forcats" solve this problem

```{r}
library(forcats)
library(tidyverse)

ggplot(data = gss_cat, aes(rincome)) +
  geom_bar()

## the bars are not odered so it is difficult to see the differences between the levels

## you can create a different plot type, using group_by() and summarise()
gss_cat %>%
  group_by(rincome) %>%
    summarise(count = length(rincome))%>%
ggplot(aes(x = fct_reorder(rincome, count), y = count)) +
  geom_point() +
  
  # to rotate the labels on the x-axis
  theme(axis.text.x=element_text(angle=90,hjust=1))

## or we can use fct_reorder() from {forcats}
ggplot(data = gss_cat, aes(x=reorder(rincome,rincome,
                     function(x)-length(x)))) +
  geom_bar() +
  # to rotate the labels on the x-axis
  theme(axis.text.x=element_text(angle=90,hjust=1))

```

1B) What is the most common `relig` in this survey? What's the most common `partyid`?

**TIPS**
 - You have to `group_by` religion, 
 - Than count the number of people per religion with `count`
 - Than arrange the result in descending order with `arrange(desc(relig))`

```{r}
gss_cat %>% 
  group_by(relig) %>% 
  count() %>%
  arrange(desc(n))

# "Protestant" is the answer
```


1C) How many `relig` of the value "Buddhism" are there in the data? How can you find out with a table? How can you find out with a visualisation?

**TIPS**
 
 - Using table on a factor reveals the number of observations per level
 - Recycle the code from the `rincome` ordered bar graph to get an ordered bar graph for `relig`
 - Remember how we found the outlier in the diamands dataset (lesson "visualizations"), by zooming in on the x-axis. Use the ggplot2 layer `coord_cartesian(ylim=c(min_value, max_value))` 

```{r}

# table
table(gss_cat$relig) 

# graph
ggplot(data = gss_cat, aes(x=reorder(relig,relig,
                     function(x)-length(x)))) +
  geom_bar() +
  # to rotate the labels on the x-axis
  theme(axis.text.x=element_text(angle=90,hjust=1)) +
  # rember how we zoomed in on the diamonds data previously?
  coord_cartesian(ylim=c(0, 160))

# there are almost 150 observations for "Buddhism" in the data. 147 to be exact, which can be deduced from the table.

```

## Finding trends in factor variables; investigating levels

2A) There are some suspiciously high numbers in `tvhours`. Is the mean a good summary? Plot `tvhours` to `relig`. What is striking about this plot?

**TIPS**

 - Checking the spread or unusal observations can be best done by creating a boxplot and/or a histogram. 


```{r}
# boxplots
gss_cat %>% na.omit() %>% 
  ggplot(aes(x = relig, y = tvhours)) +
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=90,hjust=1))

# plotting the median
gss_cat %>% na.omit() %>% select(relig, tvhours) %>%
  group_by(relig) %>%
  summarise(median_tvhours = median(tvhours)) %>%
  ggplot(aes(x = relig, y = median_tvhours)) +
    geom_point() +
  theme(axis.text.x=element_text(angle=90,hjust=1))

# in order of median tvhours
gss_cat %>% na.omit() %>% select(relig, tvhours) %>%
  group_by(relig) %>%
  summarise(median_tvhours = median(tvhours)) %>%
    ggplot(aes(x=reorder(relig, median_tvhours),
             y = median_tvhours)) +
    geom_point() +
    theme(axis.text.x=element_text(angle=90,hjust=1))
```

2B) For each factor in `gss_cat` identify whether the order of the levels is
arbitrary (no logical order) or principled (there is a logical order, e.g. from small to big or frome low to high).
```{r}
head(gss_cat)

levels(gss_cat$marital) # no obvieous ordering
levels(gss_cat$race) # no obvious ordering
levels(gss_cat$rincome) # ordered but ordering not right
levels(gss_cat$partyid) # ordered 
levels(gss_cat$relig) # order, with categories close to each other 
levels(gss_cat$denom) # no obvious ordering
```

## Modyfying factor levels

3A) How have the proportions of people identifying as Democrat, Republican, and
Independent changed over time?

**TIPS**

 - Group by year and partyid
 - Create a bar graph in hwich you reorder `partyid` in tha same way as in question 1C

```{r}
head(gss_cat)

gss_cat %>% 
  group_by(partyid, year) %>% 

ggplot(aes(x=reorder(partyid , partyid,
                     function(x)-length(x)))) +
  geom_bar() +
  
  facet_wrap(~ year) +
  # to rotate the labels on the x-axis
  theme(axis.text.x=element_text(angle=90,hjust=1)) 
  # rember how we zoomed in on the diamonds data previously?
#  coord_cartesian(ylim=c(0, 160))
```

3B) How could you collapse `rincome` into a smaller set of categories?

**TIPS**

 - Look at the "unknown" categories
 - Use the function `fct_collapse()` to tackle this exercise 
 - Try to define 4 levels: "not known", "low", "average", "high"

```{r}
library(stringr)
library(tidyverse)
library(forcats)
gss_cat <- forcats::gss_cat
head(gss_cat)

levels(gss_cat$rincome)


gss_cat %>%
  mutate(rincome_new = fct_collapse(rincome,
    not_known = c("No answer", "Don't know",
                    "Refused",  "Not applicable"),
    low = c("$4000 to 4999", "$3000 to 3999",
            "$1000 to 2999",  "Lt $1000"),
    average = c("$10000 - 14999", "$8000 to 9999", 
                "$7000 to 7999", "$6000 to 6999", "$5000 to 5999"),
    high = c("$25000 or more", "$20000 - 24999", "$15000 - 19999",
             "$10000 - 14999", "$8000 to 9999", "$7000 to 7999",
             "$6000 to 6999")))

levels(gss_cat$rincome_new)
```



3C) Reduce the variable `partyid` to 5 categories in stead of the current 10. Let R do the work for you. Look at the chapter in "R4DS" how to automatically perform this, using {forcats} functions.